# ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

WEBã‚µã‚¤ãƒˆã‚‚ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã‚‚åŒæ§˜ã®æµã‚Œã«ãªã‚‹ã‚ˆã†è¨­è¨ˆã™ã‚‹ã€‚

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

ã‚ãªãŸã¯ã€**ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªãŠã‚ˆã³ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ç²¾é€šã—ãŸãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ**ã§ã™ã€‚

ä»¥ä¸‹ã«ç¤ºã™ã®ã¯ã€ç§ãŒä½œæˆã—ãŸä¿é™ºã‚¢ãƒ—ãƒªã«ãŠã‘ã‚‹ã€â—¯â—¯æ©Ÿèƒ½ã€‘ï¼ˆä¾‹ï¼šè¦‹ç©ã‚‚ã‚Šã€ç”³è¾¼ãªã©ï¼‰ã®**Mermaidå½¢å¼ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³**ã§ã™ã€‚
ã“ã®å›³ã«å¯¾ã—ã¦ã€\*\*è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆRVï¼‰\*\*ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ã€ä»¥ä¸‹ã®è¦³ç‚¹ã«æ²¿ã£ã¦\*\*å…·ä½“çš„ãªæŒ‡æ‘˜ã¨æ”¹å–„ææ¡ˆï¼ˆå¯èƒ½ãªã‚‰ã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ãï¼‰\*\*ã‚’æç¤ºã—ã¦ãã ã•ã„ï¼š

#### ğŸ“Œ ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹

1. **è¡¨ç¾ã®æ­£ç¢ºæ€§**
   ã€€ãƒ»é€šä¿¡ã®é †åºã€å‘¼ã³å‡ºã—æ–¹å¼ï¼ˆåŒæœŸ/éåŒæœŸï¼‰ã€æˆ»ã‚Šå€¤ã®æ‰±ã„ã€ç”¨èªã®ä¸€è²«æ€§ãªã©

2. **ã‚¢ã‚¯ã‚¿ãƒ¼ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²ã®å¦¥å½“æ€§**
   ã€€ãƒ»è²¬å‹™ã®åˆ†é›¢ã‚„é…ç½®ãŒé©åˆ‡ã‹ï¼ˆä¾‹ï¼šBFFã‚„API Gatewayã€ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®è²¬å‹™ç¯„å›²ï¼‰

3. **æ¼ã‚Œãƒ»å†—é•·ã®ãƒã‚§ãƒƒã‚¯**
   ã€€ãƒ»å¿…è¦ãªå‡¦ç†ãŒæŠœã‘ã¦ã„ãªã„ã‹ã€ã¾ãŸã¯ä¸è¦ãªæ‰‹é †ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹

4. **ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªãŠã‚ˆã³ãƒ¢ãƒ€ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã®æ•´åˆæ€§**
   ã€€ãƒ»ä¾‹ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¨­è¨ˆã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è² è·ã®æœ€é©åŒ–ã€BFFã®å°å…¥åŠ¹æœã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ãªã©

5. **éåŒæœŸå‡¦ç†ï¼ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ˜ç¤ºæ€§**
   ã€€ãƒ»å¤±æ•—æ™‚ã®åˆ†å²ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ã®å¯è¦–åŒ–ãŒã•ã‚Œã¦ã„ã‚‹ã‹

6. **ãã®ä»–æ”¹å–„ç‚¹**
   ã€€ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã®ã‚ã‹ã‚Šã‚„ã™ã•ã€å›³ã®è¦‹ã‚„ã™ã•ã€ãƒãƒ¼ãƒ ã§ã®å…±æœ‰ã«é©ã—ã¦ã„ã‚‹ã‹

#### ğŸ§¾ ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆæœŸå¾…å½¢å¼

* å„è¦³ç‚¹ã”ã¨ã®**5ç‚¹æº€ç‚¹è©•ä¾¡**ã¨ã‚³ãƒ¡ãƒ³ãƒˆ
* **æ”¹å–„ææ¡ˆã•ã‚ŒãŸMermaidã‚³ãƒ¼ãƒ‰ï¼ˆã‚ã‚Œã°ï¼‰**
* **æ¬¡ã«é€²ã‚€ã¹ãã‹ / ä¿®æ­£ç¶™ç¶šã™ã¹ãã‹**ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹

#### ãƒ¡ãƒ¢
* ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯FastAPI + Keycloakã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯iOS APPãŠã‚ˆã³WEBãƒ–ãƒ©ã‚¦ã‚¶ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

## ãƒ¦ãƒ¼ã‚¶ç™»éŒ²

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant BFF as BFF (FastAPI)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant SendGrid as SendGridï¼ˆå¤–éƒ¨ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
    participant Monitoring as ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹

    %% --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å‡¦ç†é–‹å§‹ ---
    User->>Frontend: å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«è¨˜å…¥ã—ã€Œç™»éŒ²ã€ã‚¯ãƒªãƒƒã‚¯

    opt ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        Frontend->>Frontend: å¿…é ˆãƒ»å½¢å¼ãƒ»å¼·åº¦ãƒã‚§ãƒƒã‚¯
    end

    alt å…¥åŠ›ä¸å‚™
        Frontend-->>User: ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆå…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
    else ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ
        Frontend->>BFF: POST /registerï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼‰

        BFF->>Keycloak: ç®¡ç†APIã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆenabled=false, verify_email=trueï¼‰
        alt ä½œæˆå¤±æ•—
            Keycloak-->>BFF: ã‚¨ãƒ©ãƒ¼å¿œç­”
            BFF-->>Monitoring: Keycloakç™»éŒ²å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆ
            BFF-->>Frontend: 500 Internal Server Error
            Frontend-->>User: ç™»éŒ²å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
        else ä½œæˆæˆåŠŸ
            Keycloak-->>BFF: user_idè¿”å´
            BFF-->>Frontend: 201 Created

            Note over BFF,SendGrid: ãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒªãƒ³ã‚¯é€ä¿¡ã¯éåŒæœŸã‚¸ãƒ§ãƒ–ã§å‡¦ç†
            BFF->>SendGrid: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¸ãƒ§ãƒ–ç™»éŒ²ï¼ˆTo, Subject, JWTä»˜ãURLï¼‰
            
            alt ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—
                SendGrid-->>BFF: ã‚¨ãƒ©ãƒ¼
                BFF-->>Monitoring: ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—é€šçŸ¥
            else æˆåŠŸ
                SendGrid-->>BFF: OK
                BFF-->>Monitoring: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸé€šçŸ¥
            end
        end
    end

    %% --- ãƒ¡ãƒ¼ãƒ«èªè¨¼å‡¦ç† ---
    User->>Keycloak: èªè¨¼ãƒ¡ãƒ¼ãƒ«å†…ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆ/verify-link?token=...ï¼‰

    Keycloak->>Keycloak: JWTãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆç½²åãƒ»æœ‰åŠ¹æœŸé™ç¢ºèªï¼‰
    Keycloak->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨æ¸ˆã¿ã«ãƒãƒ¼ã‚¯ï¼ˆä½¿ã„æ¨ã¦åŒ–ï¼‰
    Keycloak->>Keycloak: å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ enabled=true ã«æ›´æ–°

    alt æˆåŠŸ
        Keycloak-->>User: ãƒ¡ãƒ¼ãƒ«èªè¨¼æˆåŠŸç”»é¢ or ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    else å¤±æ•—
        Keycloak-->>User: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ or æœŸé™åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼
    end

    %% --- èªè¨¼ãƒ¡ãƒ¼ãƒ«å†é€å‡¦ç† ---
    User->>Frontend: ã€Œèªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ä¿¡ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹
    Frontend->>BFF: POST /resend-verification (email)

    BFF->>Keycloak: ç®¡ç†APIã§å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    alt ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã— or ã™ã§ã«enabled
        Keycloak-->>BFF: å¯¾è±¡ãªã— or enabled=true
        BFF-->>Frontend: 400 Bad Request
        Frontend-->>User: èªè¨¼æ¸ˆã¿ã¾ãŸã¯å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“
    else æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼
        BFF->>BFF: ãƒ¡ãƒ¼ãƒ«+IPã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆRedisã¾ãŸã¯DBï¼‰

        alt ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é
            BFF-->>Frontend: 429 Too Many Requests
            Frontend-->>User: ä¸€å®šæ™‚é–“å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„
        else è¨±å¯ç¯„å›²å†…
            BFF->>Keycloak: ãƒ¡ãƒ¼ãƒ«å†é€APIã‚’å‘¼ã³å‡ºã—
            alt å¤±æ•—
                Keycloak-->>BFF: ã‚¨ãƒ©ãƒ¼
                BFF-->>Frontend: 500 Internal Server Error
                Frontend-->>User: å†é€ã«å¤±æ•—ã—ã¾ã—ãŸ
            else æˆåŠŸ
                Keycloak-->>BFF: OK
                BFF-->>Frontend: 200 OK
                Frontend-->>User: ãƒ¡ãƒ¼ãƒ«ã‚’å†é€ã—ã¾ã—ãŸ
            end
        end
    end

```

## ãƒ­ã‚°ã‚¤ãƒ³

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant BFF as BFFï¼ˆFastAPIï¼‰
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant Monitoring as ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹

    %% --- ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯ ---
    User->>Frontend: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹
    Frontend->>Frontend: SecureStorageã‹ã‚‰ access_token / refresh_token ã‚’å–å¾—
    Frontend->>Frontend: access_token ã®æœ‰åŠ¹æœŸé™ã‚’æ¤œè¨¼

    alt access_token æœ‰åŠ¹
        Frontend->>BFF: Authorizationä»˜ãAPIå‘¼ã³å‡ºã—
        BFF->>BFF: JWTç½²åã‚’å…¬é–‹éµã§æ¤œè¨¼ã—ã€expç­‰ã‚’ãƒã‚§ãƒƒã‚¯
        BFF-->>Frontend: 200 OK
        Frontend-->>User: TOPç”»é¢ã¸é·ç§»

    else access_token æœŸé™åˆ‡ã‚Œ
        alt refresh_token æœ‰åŠ¹
            Frontend->>BFF: refresh_tokenã‚’æ·»ãˆã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥è¦æ±‚
            BFF->>Keycloak: POST /token (grant_type=refresh_token)
            alt ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆåŠŸ
                Keycloak-->>BFF: æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³
                BFF-->>Frontend: æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³
                Frontend->>Frontend: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’SecureStorageã«ä¸Šæ›¸ã
                Frontend->>BFF: Authorizationä»˜ãAPIå‘¼ã³å‡ºã—
                BFF->>BFF: JWTç½²åã‚’å…¬é–‹éµã§æ¤œè¨¼ã—ã€expç­‰ã‚’ãƒã‚§ãƒƒã‚¯
                BFF-->>Frontend: 200 OK
                Frontend-->>User: TOPç”»é¢ã¸é·ç§»
            else ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—
                Keycloak-->>BFF: 401 Unauthorized
                BFF-->>Frontend: 401 Unauthorized
                Frontend->>Frontend: ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤
                Frontend->>Keycloak: èªè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆAuthorization Code + PKCEï¼‰
            end

        else refresh_token ã‚‚ç„¡åŠ¹
            Frontend->>Keycloak: èªè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆAuthorization Code + PKCEï¼‰
            %% --- åˆå›ã¾ãŸã¯æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ ---
            Frontend->>User: èªè¨¼ãƒšãƒ¼ã‚¸ï¼ˆKeycloakï¼‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            User->>Keycloak: èªè¨¼æƒ…å ±ã‚’å…¥åŠ›
            alt èªè¨¼æˆåŠŸ
                Keycloak-->>User: èªå¯ã‚³ãƒ¼ãƒ‰ä»˜ãã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                User->>Frontend: ã‚³ãƒ¼ãƒ‰ä»˜ãURLã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
                Frontend->>Keycloak: èªå¯ã‚³ãƒ¼ãƒ‰ + PKCEã§ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚
                Keycloak-->>Frontend: access_token, refresh_token
                Frontend->>Frontend: SecureStorageã«ä¿å­˜
                Frontend->>BFF: Authorizationä»˜ãAPIå‘¼ã³å‡ºã—
                BFF->>BFF: JWTç½²åã‚’å…¬é–‹éµã§æ¤œè¨¼ã—ã€expç­‰ã‚’ãƒã‚§ãƒƒã‚¯
                Frontend-->>User: TOPç”»é¢ã¸é·ç§»
                BFF->>Monitoring: login_success log
            else èªè¨¼å¤±æ•—
                Keycloak-->>Frontend: ã‚¨ãƒ©ãƒ¼ï¼ˆ401/400ï¼‰
                Frontend-->>User: ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            end
        end
    end
```

## ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant BFF as BFFï¼ˆFastAPIï¼‰
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant Monitoring as ç›£è¦–ã‚µãƒ¼ãƒ“ã‚¹

    %% --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ“ä½œã‚’å®Ÿè¡Œ ---
    User->>Frontend: ã€Œãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹
    Frontend->>Frontend: SecureStorageã‹ã‚‰ access_token / refresh_token ã‚’å–å¾—

    alt ãƒˆãƒ¼ã‚¯ãƒ³å­˜åœ¨
        Frontend->>BFF: POST /logoutï¼ˆAuthorizationãƒ˜ãƒƒãƒ€ä»˜ãï¼‰
        BFF->>Keycloak: POST /logoutï¼ˆrefresh_tokenï¼‰

        alt Keycloakã«ã‚ˆã‚‹å¤±åŠ¹æˆåŠŸ
            Keycloak-->>BFF: 204 No Content
            BFF-->>Frontend: 200 OK
            Frontend->>Frontend: SecureStorageã‹ã‚‰å…¨ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤
            Frontend-->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é·ç§»
            BFF->>Monitoring: logout_success log
        else Keycloakå´ã‚¨ãƒ©ãƒ¼
            Keycloak-->>BFF: ã‚¨ãƒ©ãƒ¼å¿œç­”
            BFF-->>Frontend: 500 Internal Server Error
            Frontend-->>User: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ
            BFF->>Monitoring: logout_failure log
        end

    else ãƒˆãƒ¼ã‚¯ãƒ³ãªã—
        Frontend->>Frontend: SecureStorageã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        Frontend-->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é·ç§»ï¼ˆå†ªç­‰å¯¾å¿œï¼‰
        Frontend->>Monitoring: logout_skipped (token_not_found)
    end

    %% --- Keycloakã‹ã‚‰ã®Backchannel Logoutãƒˆãƒªã‚¬ãƒ¼ ---
    Note over Keycloak,BFF: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«ã€BFFã¸ãƒãƒƒã‚¯ãƒãƒ£ãƒãƒ«é€šçŸ¥
    Keycloak->>BFF: POST /backchannel_logoutï¼ˆsub, sid, logout_token ãªã©ï¼‰

    BFF->>BFF: logout_tokenã®ç½²åãƒ»nonceç­‰ã‚’æ¤œè¨¼
    alt æœ‰åŠ¹ãªãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¦æ±‚
        BFF->>BFF: ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆrefresh_tokenãªã©ï¼‰ã‚’ç ´æ£„
        BFF->>Monitoring: logout_by_backchannel log
        BFF-->>Keycloak: 200 OK
    else ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³
        BFF->>Monitoring: invalid_backchannel_logout log
        BFF-->>Keycloak: 400 Bad Request
    end
```

## ä¿é™ºå•†å“ã‚’é–²è¦§ã™ã‚‹

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant API as FastAPI (public_plans_service)
    participant DB as MongoDBï¼ˆå•†å“ãƒ‡ãƒ¼ã‚¿ï¼‰<br>db: insurance<br>collection: plans
    participant S3 as S3ï¼ˆç”»åƒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰<br>bucket: insurance-app-public-img

    User->>Frontend: TOPç”»é¢ã‚’é–‹ã

    Frontend->>API: GET /api/v1/public/plans
    Note over Frontend,API: ä¿é™ºå•†å“ä¸€è¦§ã®å–å¾—ã¯èªè¨¼ä¸è¦
    API->>DB: collection.find()
    DB-->>API: ä¿é™ºå•†å“ä¸€è¦§ãƒ‡ãƒ¼ã‚¿<br>plan_id, name, description, image_key
    API->>API: JSONå½¢å¼ã«æ•´å½¢
    API-->>Frontend: ä¿é™ºå•†å“ä¸€è¦§JSON

    par å•†å“ä¸€è¦§ã®UIæ§‹ç¯‰ã¨ç”»åƒãƒ­ãƒ¼ãƒ‰
        Frontend->>User: å•†å“åãƒ»èª¬æ˜ãªã©ã‚’å³æ™‚è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
        Frontend->>S3: ç”»åƒå–å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆéåŒæœŸï¼‰
        alt ç”»åƒå–å¾—æˆåŠŸ
            S3-->>Frontend: å•†å“ç”»åƒãƒã‚¤ãƒŠãƒª
            Frontend->>User: DOMã«ç”»åƒã‚’åæ˜ 
        else ç”»åƒå–å¾—å¤±æ•—
            S3-->>Frontend: 404 Not Found
            Frontend->>User: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’è¡¨ç¤º
        end
    end
```

## ä¿é™ºè¦‹ç©ã‚‚ã‚Šã®ã¿
```mermaid
sequenceDiagram
    participant User as ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant BFFAPI as BFF (API Gateway)
    participant API as FastAPI (quotation_service)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant RDB as QuoteRDB (è¦‹ç©ã‚‚ã‚Šãƒ‡ãƒ¼ã‚¿)
    participant MongoDB as MongoDBï¼ˆåˆ©ç‡ãƒ‡ãƒ¼ã‚¿ï¼‰<br>db: rate_db<br>collection: interest_rates

    User->>Frontend: TOPç”»é¢ã§ä¿é™ºãƒ—ãƒ©ãƒ³ã‚’é¸æŠï¼ˆä¾‹ï¼šå€‹äººå¹´é‡‘ï¼‰
    Frontend->>User: è¦‹ç©ã‚‚ã‚Šå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
    User->>Frontend: æ¡ä»¶å…¥åŠ› <br> å¥‘ç´„è€…ã®ç”Ÿå¹´æœˆæ—¥ã€æ€§åˆ¥ã€æœˆé¡ä¿é™ºæ–™ã€æ‰•è¾¼æœŸé–“ã€å€‹äººå¹´é‡‘ä¿é™ºæ–™ç¨åˆ¶é©æ ¼ç‰¹ç´„ã®æœ‰ç„¡
    opt ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        Frontend->>Frontend: å¿…é ˆãƒ»å½¢å¼ãƒ»å¼·åº¦ãƒã‚§ãƒƒã‚¯
    end
    Frontend->>User: ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
    User->>Frontend: ã€Œè¦‹ç©ã‚‚ã‚Šé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹

    Frontend->>BFFAPI: POST /api/v1/quotes/{ä¿é™ºå•†å“ã”ã¨ã®PATH} <br> è¦‹ç©ã‚‚ã‚Šãƒ‡ãƒ¼ã‚¿ + session id
    Note over Frontend,BFFAPI: å­¦è³‡ä¿é™ºï¼šeducation <br>å€‹äººå¹´é‡‘ä¿é™ºï¼špension
    BFFAPI->>BFFAPI: session idã‚ˆã‚Šã€AccessTokenã¨RefreshTokenã‚’å–å¾—
    BFFAPI->>Keycloak: Tokenæ¤œè¨¼ç”¨ã®å…¬é–‹éµã‚’å–å¾—
    Keycloak-->>BFFAPI: å…¬é–‹éµ
    BFFAPI->>BFFAPI: AccessTokenã®æ¤œè¨¼
    alt AccessTokenæœ‰åŠ¹
        BFFAPI->>API: POST /api/v1/quotes/{ä¿é™ºå•†å“ã”ã¨ã®PATH} <br> è¦‹ç©ã‚‚ã‚Šãƒ‡ãƒ¼ã‚¿ + Authorizationãƒ˜ãƒƒãƒ€ã«AccessToken 
        API->>Keycloak: Tokenæ¤œè¨¼ç”¨ã®å…¬é–‹éµã‚’å–å¾—
        Keycloak-->>API: å…¬é–‹éµ
        API->>API: AccessTokenã®æ¤œè¨¼ãŠã‚ˆã³ã€å®Ÿè¡Œæ¨©é™ã®ç¢ºèª(èªå¯) 
        alt AccessTokenæœ‰åŠ¹
            API->>MongoDB: collection.find_one(start_date,end_date, rate_type, product_type)
            MongoDB-->>API: ãƒ—ãƒ©ãƒ³æƒ…å ±ï¼ˆæœ€ä½ä¿è¨¼åˆ©ç‡ã€äºˆå®šåˆ©ç‡ï¼‰
            API->>API: è¦‹ç©ã‚‚ã‚Šä½œæˆãƒ­ã‚¸ãƒƒã‚¯
            alt ä½œæˆæˆåŠŸ
                API->>RDB: INSERT è¦‹ç©ã‚‚ã‚Šçµæœ
                RDB-->>API: ä¿å­˜å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                API-->>Frontend: è¦‹ç©ã‚‚ã‚Šçµæœãƒ‡ãƒ¼ã‚¿
        else ä½œæˆå¤±æ•—
            API-->>Frontend: 400 Bad Requestï¼ˆè¨ˆç®—ä¸å¯ or å…¥åŠ›ä¸å‚™ï¼‰
        end
        else AccessTokenç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
            API-->BFFAPI: 401 Unauthorized
        end
    else AccessTokenç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        BFFAPI->>BFFAPI: RefreshTokenã®æœŸé™æ¤œè¨¼
        alt RefreshTokenæœ‰åŠ¹
            BFFAPI->>Keycloak: AccessTokenç™ºè¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            Keycloak-->>BFFAPI: AccessTokenç™ºè¡Œ
        else RefreshTokenç„¡åŠ¹
            BFFAPI-->>Frontend: 401 Unauthorized
            Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
        end
    end
```

## ä¿é™ºå¥‘ç´„ç”³è¾¼ï¼ˆæ—¢å­˜ã®è¦‹ç©ã‚‚ã‚Šæƒ…å ±ã‚’ã‚‚ã¨ã«å¥‘ç´„ç”³ã—è¾¼ã¿ï¼‰

```mermaid
sequenceDiagram
    participant User as ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant BFFAPI as BFF (API Gateway)
    participant API as FastAPI (application_service)
    participant API2 as FastAPI (quotation_service)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant RDB as ApplicationRDB (ç”³è¾¼ãƒ‡ãƒ¼ã‚¿)
    participant RDB2 as QuoteRDB (è¦‹ç©ã‚‚ã‚Šãƒ‡ãƒ¼ã‚¿)
    participant MongoDB as MongoDBï¼ˆåˆ©ç‡ãƒ‡ãƒ¼ã‚¿ï¼‰<br>db: rate_db<br>collection: interest_rates

    Frontend->>User: è¦‹ç©ã‚‚ã‚Šãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤ºï¼ˆè¦‹ç©ã‚‚ã‚Šã‹ã‚‰ãã®ã¾ã¾ç”³ã—è¾¼ã¿oréå»ã®è¦‹ç©ã‚‚ã‚Šä¸€è¦§ã‹ã‚‰é¸æŠã®2ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    User->>Frontend: ç”³ã—è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹

    Frontend->>BFFAPI: POST /api/v1/applications/{quote_id} <br> session id
    BFFAPI->>BFFAPI: session idã‚ˆã‚Šã€AccessTokenã¨RefreshTokenã‚’å–å¾—
    BFFAPI->>Keycloak: Tokenæ¤œè¨¼ç”¨ã®å…¬é–‹éµã‚’å–å¾—
    Keycloak-->>BFFAPI: å…¬é–‹éµ
    BFFAPI->>BFFAPI: AccessTokenã®æ¤œè¨¼
    alt AccessTokenæœ‰åŠ¹
        BFFAPI->>API: POST /api/v1/applications/{quote_id} <br> è¦‹ç©ã‚‚ã‚Šãƒ‡ãƒ¼ã‚¿ + Authorizationãƒ˜ãƒƒãƒ€ã«AccessToken 
        API->>API2: GET /api/v1/quote/{quote_id} + Authorizationãƒ˜ãƒƒãƒ€ã«AccessToken 
        API2-->API: è¦‹ç©ã‚‚ã‚Šçµæœãƒ‡ãƒ¼ã‚¿
        API->>API: ç”³ã—è¾¼ã¿å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        API->>API2: PUT /api/v1/quote/{quote_id} + Authorizationãƒ˜ãƒƒãƒ€ã«AccessToken <br>ç”³ã—è¾¼ã¿æ¸ˆã¿ã«å¤‰æ›´
        API2->>RDB2: UPDATE stateã‚’appliedã¸å¤‰æ›´
        RDB2-->>API2: ä¿å­˜å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        API->>RDB: INSERT ç”³ã—è¾¼ã¿æƒ…å ±
        RDB-->>API: ä¿å­˜å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
        API-->>BFFAPI:ç”³è¾¼å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆç”³è¾¼ç•ªå·ãªã©ï¼‰
        BFFAPI-->>Frontend: ç”³è¾¼å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆç”³è¾¼ç•ªå·ãªã©ï¼‰
        Frontend->>User: ç”³è¾¼å®Œäº†ç”»é¢ã‚’è¡¨ç¤º
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>BFFAPI: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        BFFAPI-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end
```

## åŠ å…¥ã—ã¦ã„ã‚‹ä¿é™ºä¸€è¦§è¡¨ç¤º

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant API as FastAPI (å¥‘ç´„ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant RDB as RDB (å¥‘ç´„ãƒ‡ãƒ¼ã‚¿)

    User->>Frontend: åŠ å…¥ä¿é™ºä¸€è¦§ç”»é¢ã‚’é–‹ã
    Frontend->>API: GET /applications/{user_id} (Authorization: Bearer Token)
    API->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    alt ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        API->>RDB: SELECT ãƒ¦ãƒ¼ã‚¶IDã‹ã‚‰å¥‘ç´„ä¸€è¦§
        RDB-->>API: ä¿é™ºå¥‘ç´„ä¸€è¦§
        API-->>Frontend: 200 OK + åŠ å…¥ä¿é™ºä¸€è¦§ãƒ‡ãƒ¼ã‚¿
        Frontend-->>User: åŠ å…¥ä¿é™ºãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        API-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end
```

## ä¿é™ºè©³ç´°ç¢ºèª

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant API as FastAPI (å¥‘ç´„ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant RDB as RDB (å¥‘ç´„ãƒ‡ãƒ¼ã‚¿)

    User->>Frontend: ä¸€è¦§ã‹ã‚‰ä¿é™ºã‚’é¸æŠ
    Frontend->>API: GET /user/contracts/{contract_id} (Authorization: Bearer Token)
    API->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    alt ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        API->>RDB: SELECT å¥‘ç´„ID
        RDB-->>API: ä¿é™ºè©³ç´° + ãƒ—ãƒ©ãƒ³æƒ…å ± + æ”¯æ‰•ã„å±¥æ­´ãªã©ã®è©³ç´°æƒ…å ±
        API-->>Frontend: 200 OK + ä¿é™ºå¥‘ç´„è©³ç´°
        Frontend-->>User: ä¿é™ºè©³ç´°ç”»é¢ã‚’è¡¨ç¤º
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        API-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end
```

## ãŠçŸ¥ã‚‰ã›ãƒã‚§ãƒƒã‚¯

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant API as FastAPI (ãŠçŸ¥ã‚‰ã›ã‚µãƒ¼ãƒ“ã‚¹)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant MongoDB as MongoDB

    User->>Frontend: ãŠçŸ¥ã‚‰ã›ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
    Frontend->>API: GET /notifications?user_id={user_id}
    API->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    alt ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        API->>MongoDB://é€šçŸ¥ä¸€è¦§ã‚’å–å¾— find({}) on notifications
        API->>MongoDB:// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¢ºèªæ¸ˆã¿é€šçŸ¥IDä¸€è¦§ã‚’å–å¾— findOne({user_id: user_id}) on user_notifications_status
        MongoDB-->>API:// ãŠçŸ¥ã‚‰ã›ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢èª­æƒ…å ±ã‚’å–å¾—
        API-->>Frontend:200 OK + ãŠçŸ¥ã‚‰ã›ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ + ç¢ºèªæ¸ˆã¿é€šçŸ¥IDä¸€è¦§
        Frontend->>User: ãŠçŸ¥ã‚‰ã›ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆç¢ºèªæ¸ˆã¿ã¯ãƒã‚§ãƒƒã‚¯ãªã©ã§è¡¨ç¤ºï¼‰
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        API-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end
    User->>Frontend: ç¢ºèªã—ãŸã„ãŠçŸ¥ã‚‰ã›ã‚’ã‚¯ãƒªãƒƒã‚¯
    Frontend->>API: GET /notifications/{id}
    API->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    alt ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        API->>MongoDB: find({{message_id:$message_id}) on notifications
        MongoDB-->>API: ãŠçŸ¥ã‚‰ã›è©³ç´°ãƒ‡ãƒ¼ã‚¿
        API-->>Frontend: 200 OK + ãŠçŸ¥ã‚‰ã›è©³ç´°ãƒ‡ãƒ¼ã‚¿
        Frontend->>User: ãŠçŸ¥ã‚‰ã›è©³ç´°ç”»é¢ã‚’è¡¨ç¤º
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        API-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end
    Note over Frontend, API:ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©³ç´°ã‚’é–²è¦§ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§<br>APIã¸æ—¢èª­ç™»éŒ²ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å ´åˆã‚‚ã‚ã‚Š
```

## å€‹äººè¨­å®š

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Frontend as ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    participant API as FastAPI (ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šAPI)
    participant Keycloak as Keycloakï¼ˆIdPï¼‰
    participant RDB as MongoDB (user_settings ãƒ†ãƒ¼ãƒ–ãƒ«)

    %% åˆæœŸè¨­å®šå–å¾—
    User->>Frontend: è¨­å®šç”»é¢ã‚’é–‹ã
    Frontend->>API: GET /users/setting/{user_id} (Authorization: Bearer Token)
    API->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    alt ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        API->>RDB: find({{user_id:$user_id}) on user_settings
        RDB-->>API: è¨­å®šãƒ‡ãƒ¼ã‚¿
        API-->>Frontend: 200 OK + è¨­å®šãƒ‡ãƒ¼ã‚¿
        Frontend-->>User: è¨­å®šã‚’ç”»é¢ã«è¡¨ç¤º
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        API-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end

    %% ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šå¤‰æ›´
    loop ä»»æ„å›æ•°
        User-->>Frontend: ON/OFFãªã©ã®å¤‰æ›´
        note right of Frontend: Stateã‚’æ›´æ–°ã—ã€<br>ä¿å­˜ç”¨ã‚¿ã‚¤ãƒãƒ¼ï¼ˆä¾‹ï¼š2ç§’ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    end

    %% ä¸€å®šæ™‚é–“æ“ä½œãŒãªã„å ´åˆã®ã¿é€ä¿¡
    Frontend->>API: PUT /users/setting/{user_id} {è¨­å®šå·®åˆ†} (Authorization: Bearer Token)
    API->>Keycloak: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    alt ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
        API->>RDB: update({user_id:$user_id},{settings:$setting_obj}) on user_settings
        RDB-->>API: æ›´æ–°å®Œäº†
        API-->>Frontend: 200 OK
        Frontend-->>User: ã€Œè‡ªå‹•ä¿å­˜å®Œäº†ã€ãªã©è»½ã„é€šçŸ¥
    else ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ãƒ»æœŸé™åˆ‡ã‚Œ
        Keycloak-->>API: ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        API-->>Frontend: 401 Unauthorized
        Frontend->>User: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå†èªè¨¼ä¿ƒã™ï¼‰
    end
```